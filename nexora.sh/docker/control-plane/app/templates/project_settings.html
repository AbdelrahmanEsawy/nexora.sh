{% extends "base.html" %}
{% block content %}
<style>
  @media (max-width: 1080px) {
    .branch-layout {
      grid-template-columns: 1fr !important;
    }
  }
  @media (max-width: 860px) {
    .repo-grid {
      grid-template-columns: 1fr !important;
    }
  }
</style>
<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="project-title">Project Settings</div>
      <div class="muted" style="font-size:12px;">Top-level project config, then branch-level operations.</div>
    </div>
    <a class="btn" href="/">Back</a>
  </div>
</div>

{% if project.status == "deleting" %}
<div class="card" style="margin-bottom:16px;">
  <div class="project-title">Deletion In Progress</div>
  <div class="muted" style="font-size:12px; margin-top:8px;">
    This project is being removed in the background. Settings are temporarily locked.
  </div>
  <div class="spacer"></div>
  {% for env in project.envs %}
    {% set status = env_status.get(env.name) %}
    <div class="row" style="justify-content: space-between; margin-bottom:8px;">
      <span class="env-pill">{{ env.name }}</span>
      <span class="muted" style="font-size:12px;">{{ status.message if status else "Deleting resources..." }}</span>
    </div>
  {% endfor %}
</div>
{% else %}

<form id="project-settings-form" class="card" method="post" action="/projects/{{ project.id }}/settings" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between; margin-bottom:10px;">
    <div>
      <div class="project-title" style="margin:0;">Project Settings</div>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        Runtime profile is project-scoped and applies to all environments (dev/staging/prod).
      </div>
    </div>
    <button class="btn primary" type="submit">Save project settings</button>
  </div>

  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Display name</div>
      <input class="input" name="display_name" value="{{ project.display_name or project.slug }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Slug (immutable)</div>
      <input class="input" value="{{ project.slug }}" disabled />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Hosting location</div>
      <select class="input" name="hosting_location">
        <option value="">Auto</option>
        {% for item in hosting_locations %}
          <option value="{{ item.code }}" {% if project.hosting_location == item.code %}selected{% endif %}>{{ item.label }} ({{ item.region }})</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Measured ping (ms)</div>
      <input class="input" type="number" min="1" name="hosting_ping_ms" value="{{ project.hosting_ping_ms or '' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Development branch</div>
      <input class="input" name="dev_branch" value="{{ project.dev_branch or 'dev' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branch</div>
      <input class="input" name="staging_branch" value="{{ project.staging_branch or 'staging' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Production branch</div>
      <input class="input" name="prod_branch" value="{{ project.prod_branch or 'main' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Database workers</div>
      <input class="input" type="number" min="1" name="workers" value="{{ project.workers or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Filestore size (Gi)</div>
      <input class="input" type="number" min="1" name="storage_gb" value="{{ project.storage_gb or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branches</div>
      <input class="input" type="number" min="1" name="staging_slots" value="{{ project.staging_slots or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Odoo version (community)</div>
      <input class="input" name="odoo_version" value="{{ project.odoo_version or '19.0' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div>
    <div class="muted" style="font-size:12px; margin-bottom:6px;">Subscription code</div>
    <input class="input" name="subscription_code" value="{{ project.subscription_code or '' }}" />
  </div>
</form>

<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between; margin-bottom:10px;">
    <div>
      <div class="project-title" style="margin:0;">Repository</div>
      <div class="muted" style="font-size:12px;">Connect GitHub to enable branch-triggered updates.</div>
    </div>
    <a class="btn" href="{{ github_install_url }}" target="_blank">Install GitHub App</a>
  </div>
  <form method="post" action="/projects/{{ project.id }}/repo">
    <div class="grid repo-grid" style="grid-template-columns: 1.4fr 1fr auto; align-items: end;">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Repository (owner/name)</div>
        <input class="input" name="repo_full_name" value="{{ project.repo_full_name or '' }}" list="repo-list" />
        <div class="muted" style="font-size:11px; margin-top:6px;">Leave empty to auto-create and connect <code>{{ project.slug }}</code> in the selected installation.</div>
        <datalist id="repo-list">
          {% for repo in repos %}
            <option value="{{ repo.full_name }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Installation</div>
        <select class="input" name="installation_id">
          <option value="">Select installation</option>
          {% for inst in installations %}
            <option value="{{ inst.installation_id }}" {% if project.installation_id == inst.installation_id %}selected{% endif %}>
              {{ inst.account_login }} ({{ inst.installation_id }})
            </option>
          {% endfor %}
        </select>
      </div>
      <button class="btn primary" type="submit" style="height:44px;">Connect</button>
    </div>
  </form>
</div>

{% set dev_env = (project.envs | selectattr("name","equalto","dev") | list | first) %}
{% set staging_env = (project.envs | selectattr("name","equalto","staging") | list | first) %}
{% set prod_env = (project.envs | selectattr("name","equalto","prod") | list | first) %}

<div class="grid branch-layout" style="grid-template-columns: 250px 1fr; align-items:start; gap:14px;">
  <aside class="card" id="branches">
    <div class="project-title">Branches</div>
    <div class="muted" style="font-size:12px; margin-bottom:12px;">Left panel like Odoo.sh: choose active branch.</div>
    {% for env_name in ["dev", "staging", "prod"] %}
      {% set env_obj = (project.envs | selectattr("name","equalto", env_name) | list | first) %}
      {% set status = env_status.get(env_name) %}
      <a class="btn {% if selected_env == env_name %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ env_name }}&tab={{ selected_tab }}#branch-workspace" style="width:100%; justify-content:space-between; margin-bottom:8px;">
        <span class="env-pill" style="{% if selected_env == env_name %}background:rgba(11,15,26,0.2); color:#0b0f1a; border-color:rgba(11,15,26,0.2);{% endif %}">{{ env_name }}</span>
        <span class="muted" style="font-size:11px; {% if selected_env == env_name %}color:#0b0f1a; opacity:0.8;{% endif %}">
          {% if env_obj %}{{ status.message if status else 'Unknown' }}{% else %}Not created{% endif %}
        </span>
      </a>
    {% endfor %}
  </aside>

  <section class="card" id="branch-workspace">
    <div class="row" style="justify-content: space-between; margin-bottom:10px;">
      <div>
        <div class="project-title" style="margin:0;">Branch Workspace · {{ selected_env }}</div>
        {% if selected_env_obj %}
          <div class="muted" style="font-size:12px; margin-top:4px;">{{ selected_env_obj.host }} · {{ env_status.get(selected_env).message if env_status.get(selected_env) else 'Unknown' }}</div>
        {% else %}
          <div class="muted" style="font-size:12px; margin-top:4px;">Environment not created yet.</div>
        {% endif %}
      </div>
      <div class="row" style="justify-content:flex-end;">
        {% if selected_env_obj %}
          <a class="btn" href="/projects/{{ project.id }}/env/{{ selected_env }}/open">Open</a>
          <form method="post" action="/projects/{{ project.id }}/envs/restart">
            <input type="hidden" name="env" value="{{ selected_env }}" />
            <button class="btn ghost" type="submit">Restart</button>
          </form>
          <form method="post" action="/projects/{{ project.id }}/envs/redeploy">
            <input type="hidden" name="env" value="{{ selected_env }}" />
            <button class="btn ghost" type="submit">Redeploy</button>
          </form>
        {% endif %}

        {% if selected_env == 'dev' and selected_env_obj %}
          <form method="post" action="/projects/{{ project.id }}/reset">
            <input type="hidden" name="env" value="dev" />
            <button class="btn ghost danger" type="submit">Reset dev (empty)</button>
          </form>
          <form method="post" action="/projects/{{ project.id }}/promote">
            <input type="hidden" name="source_env" value="dev" />
            <input type="hidden" name="target_env" value="staging" />
            <button class="btn ghost" type="submit">
              {{ "Promote dev → staging" if staging_env else "Create staging from dev" }}
            </button>
          </form>
          <form method="post" action="/projects/{{ project.id }}/promote">
            <input type="hidden" name="source_env" value="dev" />
            <input type="hidden" name="target_env" value="prod" />
            <button class="btn ghost" type="submit">
              {{ "Promote dev → prod" if prod_env else "Create prod from dev" }}
            </button>
          </form>
        {% endif %}

        {% if selected_env == 'staging' %}
          {% if dev_env %}
          <form method="post" action="/projects/{{ project.id }}/promote">
            <input type="hidden" name="source_env" value="dev" />
            <input type="hidden" name="target_env" value="staging" />
            <button class="btn ghost" type="submit">Promote dev → staging</button>
          </form>
          {% endif %}
          {% if prod_env %}
          <form method="post" action="/projects/{{ project.id }}/reset-from-prod">
            <input type="hidden" name="target_env" value="staging" />
            <button class="btn ghost" type="submit">Copy prod → staging</button>
          </form>
          {% endif %}
        {% endif %}

        {% if selected_env == 'prod' %}
          {% if staging_env %}
          <form method="post" action="/projects/{{ project.id }}/promote">
            <input type="hidden" name="source_env" value="staging" />
            <input type="hidden" name="target_env" value="prod" />
            <button class="btn ghost" type="submit">Promote staging → prod</button>
          </form>
          {% endif %}
          {% if dev_env %}
          <form method="post" action="/projects/{{ project.id }}/promote">
            <input type="hidden" name="source_env" value="dev" />
            <input type="hidden" name="target_env" value="prod" />
            <button class="btn ghost" type="submit">Promote dev → prod</button>
          </form>
          {% endif %}
        {% endif %}

        {% if not selected_env_obj %}
          {% if selected_env == 'dev' %}
            <form method="post" action="/projects/{{ project.id }}/envs/create">
              <input type="hidden" name="env" value="dev" />
              <button class="btn primary" type="submit">Create dev</button>
            </form>
          {% elif selected_env == 'staging' %}
            {% if prod_env %}
              <form method="post" action="/projects/{{ project.id }}/reset-from-prod">
                <input type="hidden" name="target_env" value="staging" />
                <button class="btn primary" type="submit">Create staging from prod</button>
              </form>
            {% elif dev_env %}
              <form method="post" action="/projects/{{ project.id }}/promote">
                <input type="hidden" name="source_env" value="dev" />
                <input type="hidden" name="target_env" value="staging" />
                <button class="btn primary" type="submit">Create staging from dev</button>
              </form>
            {% endif %}
          {% elif selected_env == 'prod' %}
            {% if staging_env %}
              <form method="post" action="/projects/{{ project.id }}/promote">
                <input type="hidden" name="source_env" value="staging" />
                <input type="hidden" name="target_env" value="prod" />
                <button class="btn primary" type="submit">Create prod from staging</button>
              </form>
            {% elif dev_env %}
              <form method="post" action="/projects/{{ project.id }}/promote">
                <input type="hidden" name="source_env" value="dev" />
                <input type="hidden" name="target_env" value="prod" />
                <button class="btn primary" type="submit">Create prod from dev</button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div class="row" style="margin-bottom:12px; gap:8px;">
      <a class="btn {% if selected_tab == 'history' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=history#branch-workspace">History</a>
      <a class="btn {% if selected_tab == 'logs' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=logs#branch-workspace">Logs</a>
      <a class="btn {% if selected_tab == 'settings' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=settings#branch-workspace">Environment settings</a>
    </div>

    {% if selected_tab == 'history' %}
      {% if branch_history %}
        {% for build in branch_history %}
          <div class="card" style="background:#0b1220; margin-bottom:8px; border-color:rgba(255,255,255,0.06); box-shadow:none;">
            <div class="row" style="justify-content:space-between; margin-bottom:6px;">
              <div style="font-weight:600;">
                {{ (build.env or selected_env)|upper }} · {{ build.status or 'event' }}
              </div>
              <div class="muted" style="font-size:12px;">{{ build.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            </div>
            <div class="muted" style="font-size:12px; margin-bottom:4px;">Branch: {{ build.branch or 'n/a' }}{% if build.sha %} · SHA: {{ build.sha[:8] }}{% endif %}</div>
            <div style="font-size:13px;">{{ build.message or '-' }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="font-size:12px;">No history yet for {{ selected_env }}.</div>
      {% endif %}
    {% elif selected_tab == 'logs' %}
      <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none;">
        <div class="muted" style="font-size:12px; margin-bottom:8px;">Latest logs for {{ selected_env }} (runtime pod or init job while provisioning).</div>
        <pre style="white-space:pre-wrap; margin:0; font-size:12px; line-height:1.35; max-height:520px; overflow:auto;">{{ branch_logs }}</pre>
      </div>
    {% else %}
      {% if selected_env_obj %}
        <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none; margin-bottom:10px;">
          <div class="project-title" style="font-size:16px; margin-bottom:10px;">Environment settings</div>
          <div class="muted" style="font-size:12px; margin-bottom:10px;">
            Database workers, filestore size, and Odoo version are managed from Project Settings only.
          </div>
          <a class="btn" href="#project-settings-form">Go to Project Settings</a>
        </div>

        <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none;">
          <div class="project-title" style="font-size:16px; margin-bottom:10px;">Custom domains</div>
          {% if selected_env_obj.domains %}
            {% for domain in selected_env_obj.domains %}
            <div class="row" style="justify-content:space-between; margin-bottom:8px;">
              <span>{{ domain.host }}</span>
              <form method="post" action="/projects/{{ project.id }}/domains/{{ domain.id }}/delete">
                <button class="btn ghost danger" type="submit">Remove</button>
              </form>
            </div>
            {% endfor %}
          {% else %}
            <div class="muted" style="font-size:12px; margin-bottom:10px;">No custom domains yet.</div>
          {% endif %}
          <form method="post" action="/projects/{{ project.id }}/domains" class="row">
            <input type="hidden" name="env_id" value="{{ selected_env_obj.id }}" />
            <input class="input" name="host" placeholder="custom.domain.com" required />
            <button class="btn primary" type="submit">Add domain</button>
          </form>
        </div>
      {% else %}
        <div class="muted" style="font-size:12px;">Create {{ selected_env }} first, then environment settings will appear here.</div>
      {% endif %}
    {% endif %}
  </section>
</div>
{% endif %}
{% endblock %}
