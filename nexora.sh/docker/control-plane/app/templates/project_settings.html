{% extends "base.html" %}
{% block content %}
<style>
  @media (max-width: 1080px) {
    .branch-layout {
      grid-template-columns: 1fr !important;
    }
  }
  @media (max-width: 860px) {
    .repo-grid {
      grid-template-columns: 1fr !important;
    }
  }
  .stage-block {
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(11,18,32,0.55);
  }
  .stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .stage-title {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.2px;
  }
  .branch-slot {
    width: 100%;
  }
  .branch-slot.drop-target {
    border-color: rgba(34,211,238,0.65) !important;
    box-shadow: 0 0 0 2px rgba(34,211,238,0.2) inset;
  }
  .branch-slot.dragging {
    opacity: 0.7;
    transform: scale(0.99);
  }
  .branch-line {
    min-height: 56px;
    justify-content: space-between;
    align-items: center;
  }
  .branch-line-main {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 3px;
  }
  .branch-name {
    font-size: 13px;
    font-weight: 600;
  }
  .branch-db {
    font-size: 10px;
    color: var(--muted);
    opacity: 0.9;
  }
  .progress-wrap {
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 10px 12px;
    margin-bottom: 10px;
    background: rgba(11,18,32,0.65);
  }
  .progress-wrap.error {
    border-color: rgba(248,113,113,0.45);
    background: rgba(127,29,29,0.2);
  }
  .progress-track {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.12);
    overflow: hidden;
    margin-top: 8px;
  }
  .progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #22d3ee, #ff7a59);
    transition: width 0.4s ease;
  }
  .progress-wrap.error .progress-fill {
    background: linear-gradient(90deg, #f87171, #fb7185);
  }
  @keyframes pulse-progress {
    0% { transform: translateX(-10%); opacity: 0.65; }
    50% { transform: translateX(8%); opacity: 1; }
    100% { transform: translateX(-10%); opacity: 0.65; }
  }
  .top-shortcuts {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .workspace-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: flex-end;
    flex-wrap: wrap;
  }
  .workspace-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
</style>
<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="project-title">Project Settings</div>
      <div class="muted" style="font-size:12px;">Manage runtime profile, branches, backups, and environment operations from one page.</div>
    </div>
    <div class="top-shortcuts">
      <a class="btn ghost" href="#branch-workspace">Open Workspace</a>
      <a class="btn ghost" href="#project-settings-form">Project Settings</a>
      <a class="btn" href="/">Back</a>
    </div>
  </div>
</div>

{% if project.status == "deleting" %}
<div class="card" style="margin-bottom:16px;">
  <div class="project-title">Deletion In Progress</div>
  <div class="muted" style="font-size:12px; margin-top:8px;">
    This project is being removed in the background. Settings are temporarily locked.
  </div>
  <div class="spacer"></div>
  {% for env in project.envs %}
    {% set status = env_status.get(env.name) %}
    <div class="row" style="justify-content: space-between; margin-bottom:8px;">
      <span class="env-pill">{{ env.name }}</span>
      <span class="muted" style="font-size:12px;">{{ status.message if status else "Deleting resources..." }}</span>
    </div>
  {% endfor %}
</div>
{% else %}

<form id="project-settings-form" class="card" method="post" action="/projects/{{ project.id }}/settings" style="margin-bottom:16px;" data-long-action="Saving project settings...">
  <div class="row" style="justify-content: space-between; margin-bottom:10px;">
    <div>
      <div class="project-title" style="margin:0;">Project Settings</div>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        Runtime profile is project-scoped and applies to all environments (dev/staging/prod).
      </div>
    </div>
    <button class="btn primary" type="submit">Save project settings</button>
  </div>

  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Display name</div>
      <input class="input" name="display_name" value="{{ project.display_name or project.slug }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Slug (immutable)</div>
      <input class="input" value="{{ project.slug }}" disabled />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Hosting location</div>
      <select class="input" name="hosting_location">
        <option value="">Auto</option>
        {% for item in hosting_locations %}
          <option value="{{ item.code }}" {% if project.hosting_location == item.code %}selected{% endif %}>{{ item.label }} ({{ item.region }})</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Measured ping (ms)</div>
      <input class="input" type="number" min="1" name="hosting_ping_ms" value="{{ project.hosting_ping_ms or '' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Development branch</div>
      <input class="input" name="dev_branch" value="{{ project.dev_branch or 'dev' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branch</div>
      <input class="input" name="staging_branch" value="{{ project.staging_branch or 'staging' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Production branch</div>
      <input class="input" name="prod_branch" value="{{ project.prod_branch or 'main' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Database workers</div>
      <input class="input" type="number" min="1" name="workers" value="{{ project.workers or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Filestore size (Gi)</div>
      <input class="input" type="number" min="1" name="storage_gb" value="{{ project.storage_gb or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branches</div>
      <input class="input" type="number" min="1" name="staging_slots" value="{{ project.staging_slots or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Odoo version (community)</div>
      <input class="input" name="odoo_version" value="{{ project.odoo_version or '19.0' }}" />
    </div>
  </div>

  <div class="spacer"></div>
  <div>
    <div class="muted" style="font-size:12px; margin-bottom:6px;">Subscription code</div>
    <input class="input" name="subscription_code" value="{{ project.subscription_code or '' }}" />
  </div>
</form>

<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between; margin-bottom:10px;">
    <div>
      <div class="project-title" style="margin:0;">Repository</div>
      <div class="muted" style="font-size:12px;">Connect GitHub to enable branch-triggered updates.</div>
    </div>
    <a class="btn" href="{{ github_install_url }}" target="_blank">Install GitHub App</a>
  </div>
  <form method="post" action="/projects/{{ project.id }}/repo" data-long-action="Connecting repository...">
    <div class="grid repo-grid" style="grid-template-columns: 1.4fr 1fr auto; align-items: end;">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Repository (owner/name)</div>
        <input class="input" name="repo_full_name" value="{{ project.repo_full_name or '' }}" list="repo-list" />
        <div class="muted" style="font-size:11px; margin-top:6px;">Leave empty to auto-create and connect <code>{{ project.slug }}</code> in the selected installation.</div>
        <datalist id="repo-list">
          {% for repo in repos %}
            <option value="{{ repo.full_name }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Installation</div>
        <select class="input" name="installation_id">
          <option value="">Select installation</option>
          {% for inst in installations %}
            <option value="{{ inst.installation_id }}" {% if project.installation_id == inst.installation_id %}selected{% endif %}>
              {{ inst.account_login }} ({{ inst.installation_id }})
            </option>
          {% endfor %}
        </select>
      </div>
      <button class="btn primary" type="submit" style="height:44px;">Connect</button>
    </div>
  </form>
</div>

{% set dev_env = (project.envs | selectattr("name","equalto","dev") | list | first) %}
{% set staging_env = (project.envs | selectattr("name","equalto","staging") | list | first) %}
{% set prod_env = (project.envs | selectattr("name","equalto","prod") | list | first) %}

<div class="grid branch-layout" style="grid-template-columns: 250px 1fr; align-items:start; gap:14px;">
  <aside class="card" id="branches">
    <div class="project-title" style="margin-bottom:4px;">Stage Pipeline</div>
    <div class="muted" style="font-size:12px; margin-bottom:10px;">
      Fixed stages like Odoo.sh. Drag branch/database lines to move or merge safely between stages.
    </div>
    {% for env_name in ["prod", "staging", "dev"] %}
      {% set env_obj = (project.envs | selectattr("name","equalto", env_name) | list | first) %}
      {% set status = env_status.get(env_name) %}
      {% set env_branch = project.dev_branch if env_name == "dev" else (project.staging_branch if env_name == "staging" else project.prod_branch) %}
      {% set stage_label = stage_labels.get(env_name, env_name|title) %}
      <div class="stage-block">
        <div class="stage-header">
          <div class="stage-title">{{ stage_label }}</div>
          <button
            type="button"
            class="btn ghost branch-plus"
            data-target-env="{{ env_name }}"
            title="Duplicate into {{ stage_label }}"
            style="padding:8px 11px;"
          >+</button>
        </div>
        <a
          class="btn env-card branch-slot branch-line {% if selected_env == env_name %}primary{% else %}ghost{% endif %}"
          href="/projects/{{ project.id }}/settings?env={{ env_name }}&tab={{ selected_tab }}#branch-workspace"
          data-env="{{ env_name }}"
          data-exists="{{ 1 if env_obj else 0 }}"
          draggable="{{ 'true' if env_obj else 'false' }}"
          title="{% if env_obj %}Drag this branch line to another stage{% else %}Drop here to create and copy/reset{% endif %}"
        >
          <span class="branch-line-main">
            <span class="branch-name" style="{% if selected_env == env_name %}color:#0b0f1a;{% endif %}">
              {{ env_branch or env_name }}
            </span>
            <span class="branch-db" style="{% if selected_env == env_name %}color:#0b0f1a; opacity:0.75;{% endif %}">
              {{ env_obj.db_name if env_obj else "Database not created yet" }}
            </span>
          </span>
          <span class="muted" style="font-size:11px; {% if selected_env == env_name %}color:#0b0f1a; opacity:0.8;{% endif %}">
            {% if env_obj %}{{ status.message if status else 'Unknown' }}{% else %}Not created{% endif %}
          </span>
        </a>
      </div>
    {% endfor %}

    <form id="branch-dnd-form" method="post" action="/projects/{{ project.id }}/branches/transfer" style="display:none;" data-long-action="Starting branch transfer...">
      <input type="hidden" name="source_env" id="dnd-source-env" />
      <input type="hidden" name="target_env" id="dnd-target-env" />
      <input type="hidden" name="mode" id="dnd-mode" value="copy" />
    </form>

    <div id="branch-dup-panel" class="card" style="display:none; margin-top:10px; padding:12px; background:#0b1220; border-color:rgba(255,255,255,0.08); box-shadow:none;">
      <div class="project-title" style="font-size:14px; margin-bottom:8px;">Fork / Duplicate Branch</div>
      <form id="branch-dup-form" method="post" action="/projects/{{ project.id }}/branches/transfer" data-long-action="Starting branch duplicate...">
        <input type="hidden" name="target_env" id="dup-target-env" value="{{ selected_env }}" />
        <input type="hidden" name="mode" value="copy" />
        <div id="dup-target-label" class="muted" style="font-size:12px; margin-bottom:8px;">
          Target stage: {{ stage_labels.get(selected_env, selected_env|title) }}
        </div>
        <select class="input" name="source_env" id="dup-source-env" style="margin-bottom:8px;" required>
          {% for source_name in ["dev", "staging", "prod"] %}
            {% set source_obj = (project.envs | selectattr("name","equalto", source_name) | list | first) %}
            {% if source_obj %}
              {% set source_branch = project.dev_branch if source_name == "dev" else (project.staging_branch if source_name == "staging" else project.prod_branch) %}
              {% set source_stage = stage_labels.get(source_name, source_name|title) %}
              <option value="{{ source_name }}">{{ source_stage }} · {{ source_branch or source_name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn ghost" type="button" id="branch-dup-cancel">Cancel</button>
          <button class="btn primary" type="submit">Run duplicate</button>
        </div>
      </form>
    </div>
  </aside>

  <section class="card" id="branch-workspace">
    {% set selected_status = env_status.get(selected_env) %}
    <div class="row" style="justify-content: space-between; margin-bottom:10px;">
      <div>
        <div class="project-title" style="margin:0;">Branch Workspace · {{ selected_stage_label }}</div>
        {% if selected_env_obj %}
          <div class="muted" style="font-size:12px; margin-top:4px;">{{ selected_env_obj.host }} · {{ selected_status.message if selected_status else 'Unknown' }}</div>
        {% else %}
          <div class="muted" style="font-size:12px; margin-top:4px;">Environment not created yet.</div>
        {% endif %}
      </div>
      <div class="workspace-actions">
        {% if selected_env_obj %}
          <a class="btn" href="/projects/{{ project.id }}/env/{{ selected_env }}/open">Connect</a>
          <a class="btn ghost" href="#project-settings-form">Settings</a>
          <form method="post" action="/projects/{{ project.id }}/envs/restart" data-confirm="Restart {{ selected_stage_label }} runtime now?" data-long-action="Restarting {{ selected_stage_label }} runtime...">
            <input type="hidden" name="env" value="{{ selected_env }}" />
            <button class="btn ghost {% if selected_env_busy %}disabled{% endif %}" type="submit" {% if selected_env_busy %}disabled{% endif %}>Restart</button>
          </form>
          <form method="post" action="/projects/{{ project.id }}/envs/redeploy" data-confirm="Redeploy {{ selected_stage_label }} resources now?" data-long-action="Redeploying {{ selected_stage_label }}...">
            <input type="hidden" name="env" value="{{ selected_env }}" />
            <button class="btn ghost {% if selected_env_busy %}disabled{% endif %}" type="submit" {% if selected_env_busy %}disabled{% endif %}>Redeploy</button>
          </form>
        {% endif %}

        {% if selected_env == 'dev' and selected_env_obj %}
          <form method="post" action="/projects/{{ project.id }}/reset" data-confirm="Reset Development to an empty database and filestore?" data-long-action="Resetting Development environment...">
            <input type="hidden" name="env" value="dev" />
            <button class="btn ghost danger {% if selected_env_busy %}disabled{% endif %}" type="submit" {% if selected_env_busy %}disabled{% endif %}>Reset dev (empty)</button>
          </form>
        {% endif %}

        {% if not selected_env_obj %}
          {% if selected_env == 'dev' %}
            <form method="post" action="/projects/{{ project.id }}/envs/create" data-long-action="Creating Development environment...">
              <input type="hidden" name="env" value="dev" />
              <button class="btn primary" type="submit">Create dev</button>
            </form>
          {% elif selected_env == 'staging' %}
            {% if prod_env %}
              <form method="post" action="/projects/{{ project.id }}/reset-from-prod" data-confirm="Create Staging from Production snapshot?" data-long-action="Creating Staging from Production...">
                <input type="hidden" name="target_env" value="staging" />
                <button class="btn primary" type="submit">Create staging from prod</button>
              </form>
            {% elif dev_env %}
              <form method="post" action="/projects/{{ project.id }}/promote" data-confirm="Create Staging from Development?" data-long-action="Creating Staging from Development...">
                <input type="hidden" name="source_env" value="dev" />
                <input type="hidden" name="target_env" value="staging" />
                <button class="btn primary" type="submit">Create staging from dev</button>
              </form>
            {% endif %}
          {% elif selected_env == 'prod' %}
            {% if staging_env %}
              <form method="post" action="/projects/{{ project.id }}/promote" data-confirm="Go live from Staging to Production?" data-long-action="Promoting Staging to Production...">
                <input type="hidden" name="source_env" value="staging" />
                <input type="hidden" name="target_env" value="prod" />
                <button class="btn primary" type="submit">Create prod from staging</button>
              </form>
            {% elif dev_env %}
              <form method="post" action="/projects/{{ project.id }}/promote" data-confirm="Go live from Development to Production?" data-long-action="Promoting Development to Production...">
                <input type="hidden" name="source_env" value="dev" />
                <input type="hidden" name="target_env" value="prod" />
                <button class="btn primary" type="submit">Create prod from dev</button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>

    <div id="workspace-long-op" class="progress-wrap" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <span style="font-size:12px;">Operation</span>
        <span style="font-size:12px;">Running...</span>
      </div>
      <div id="workspace-long-op-message" class="muted" style="font-size:12px; margin-top:4px;">Processing operation...</div>
      <div class="progress-track">
        <div class="progress-fill" style="width: 35%; animation: pulse-progress 1.6s ease-in-out infinite;"></div>
      </div>
    </div>

    {% if workspace_progress %}
      <div id="workspace-progress-wrap" class="progress-wrap {% if workspace_progress.tone == 'error' %}error{% endif %}">
        <div class="row" style="justify-content:space-between;">
          <span style="font-size:12px;">Operation progress</span>
          <span id="workspace-progress-percent" style="font-size:12px;">{{ workspace_progress.percent }}%</span>
        </div>
        <div id="workspace-progress-message" class="muted" style="font-size:12px; margin-top:4px;">{{ workspace_progress.message }}</div>
        <div class="progress-track">
          <div id="workspace-progress-fill" class="progress-fill" style="width: {{ workspace_progress.percent }}%;"></div>
        </div>
      </div>
    {% endif %}

    <div class="muted" style="font-size:12px; margin-bottom:10px;">
      Manage stages from the left panel only. Drag the branch/database line to move/merge between
      <code>Production</code>, <code>Staging</code>, and <code>Development</code>.
      Drop on <code>Development</code> resets dev from source; drop on <code>Production</code> starts live move.
    </div>

    <div class="workspace-tabs">
      <a class="btn {% if selected_tab == 'history' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=history#branch-workspace">History</a>
      <a class="btn {% if selected_tab == 'logs' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=logs#branch-workspace">Logs</a>
      <a class="btn {% if selected_tab == 'backups' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=backups#branch-workspace">Backups</a>
      <a class="btn {% if selected_tab == 'settings' %}primary{% else %}ghost{% endif %}" href="/projects/{{ project.id }}/settings?env={{ selected_env }}&tab=settings#branch-workspace">Settings</a>
    </div>

    {% if selected_tab == 'history' %}
      {% if branch_history %}
        {% for build in branch_history %}
          <div class="card" style="background:#0b1220; margin-bottom:8px; border-color:rgba(255,255,255,0.06); box-shadow:none;">
            <div class="row" style="justify-content:space-between; margin-bottom:6px;">
              <div style="font-weight:600;">
                {{ (build.env or selected_env)|upper }} · {{ build.status or 'event' }}
              </div>
              <div class="muted" style="font-size:12px;">{{ build.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            </div>
            <div class="muted" style="font-size:12px; margin-bottom:4px;">Branch: {{ build.branch or 'n/a' }}{% if build.sha %} · SHA: {{ build.sha[:8] }}{% endif %}</div>
            <div style="font-size:13px;">{{ build.message or '-' }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="muted" style="font-size:12px;">No history yet for {{ selected_env }}.</div>
      {% endif %}
    {% elif selected_tab == 'logs' %}
      <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none;">
        <div class="muted" style="font-size:12px; margin-bottom:8px;">Latest logs for {{ selected_env }} (runtime pod or init job while provisioning).</div>
        <pre style="white-space:pre-wrap; margin:0; font-size:12px; line-height:1.35; max-height:520px; overflow:auto;">{{ branch_logs }}</pre>
      </div>
    {% elif selected_tab == 'backups' %}
      <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none; margin-bottom:10px;">
        <div class="project-title" style="font-size:16px; margin-bottom:10px;">Daily Backups</div>
        <div class="muted" style="font-size:12px; margin-bottom:10px;">
          Automatic daily backups are enabled. You can create, restore, import, and export backups for {{ selected_env }} here.
        </div>
        <div class="row" style="margin-bottom:10px;">
          <form method="post" action="/projects/{{ project.id }}/backups/create" data-long-action="Creating backup snapshot...">
            <input type="hidden" name="env" value="{{ selected_env }}" />
            <button class="btn primary" type="submit">Create backup now</button>
          </form>
        </div>
        <form method="post" action="/projects/{{ project.id }}/backups/import" class="row" data-long-action="Importing backup reference...">
          <input type="hidden" name="env" value="{{ selected_env }}" />
          <input class="input" name="object_path" placeholder="snapshots/project/dev/20260226T050000Z.tgz" required />
          <button class="btn ghost" type="submit">Import backup</button>
        </form>
      </div>

      <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none;">
        <div class="project-title" style="font-size:16px; margin-bottom:10px;">Backup History · {{ selected_env }}</div>
        {% if backup_items %}
          {% for backup in backup_items %}
            <div class="card" style="background:#0a1020; margin-bottom:8px; border-color:rgba(255,255,255,0.06); box-shadow:none;">
              <div class="row" style="justify-content:space-between; margin-bottom:6px;">
                <div style="font-size:13px; font-weight:600;">#{{ backup.id }} · {{ (backup.source or 'manual')|upper }} · {{ (backup.status or 'unknown')|upper }}</div>
                <div class="muted" style="font-size:12px;">{{ backup.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
              </div>
              <div class="muted" style="font-size:12px; margin-bottom:6px;">{{ backup.object_path or '-' }}</div>
              {% if backup.note %}<div class="muted" style="font-size:12px; margin-bottom:8px;">{{ backup.note }}</div>{% endif %}
              <div class="row" style="justify-content:flex-end;">
                <form method="post" action="/projects/{{ project.id }}/backups/{{ backup.id }}/restore" data-confirm="Restore backup #{{ backup.id }} to {{ selected_env }}?" data-long-action="Restoring backup #{{ backup.id }}...">
                  <button class="btn ghost" type="submit">Restore</button>
                </form>
                <a class="btn ghost" href="/projects/{{ project.id }}/backups/{{ backup.id }}/export">Export</a>
                <form method="post" action="/projects/{{ project.id }}/backups/{{ backup.id }}/delete" data-confirm="Delete backup #{{ backup.id }} from the list?" data-long-action="Deleting backup #{{ backup.id }}...">
                  <button class="btn ghost danger" type="submit">Delete</button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="font-size:12px;">No backups yet for {{ selected_env }}.</div>
        {% endif %}
      </div>
    {% else %}
      {% if selected_env_obj %}
        <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none; margin-bottom:10px;">
          <div class="project-title" style="font-size:16px; margin-bottom:10px;">Environment settings</div>
          <div class="muted" style="font-size:12px; margin-bottom:10px;">
            Database workers, filestore size, and Odoo version are managed from Project Settings only.
          </div>
          <a class="btn" href="#project-settings-form">Go to Project Settings</a>
        </div>

        <div class="card" style="background:#0b1220; border-color:rgba(255,255,255,0.06); box-shadow:none;">
          <div class="project-title" style="font-size:16px; margin-bottom:10px;">Custom domains</div>
          {% if selected_env_obj.domains %}
            {% for domain in selected_env_obj.domains %}
            <div class="row" style="justify-content:space-between; margin-bottom:8px;">
              <span>{{ domain.host }}</span>
              <form method="post" action="/projects/{{ project.id }}/domains/{{ domain.id }}/delete" data-confirm="Remove domain {{ domain.host }}?" data-long-action="Removing domain {{ domain.host }}...">
                <button class="btn ghost danger" type="submit">Remove</button>
              </form>
            </div>
            {% endfor %}
          {% else %}
            <div class="muted" style="font-size:12px; margin-bottom:10px;">No custom domains yet.</div>
          {% endif %}
          <form method="post" action="/projects/{{ project.id }}/domains" class="row" data-long-action="Adding custom domain...">
            <input type="hidden" name="env_id" value="{{ selected_env_obj.id }}" />
            <input class="input" name="host" placeholder="custom.domain.com" required />
            <button class="btn primary" type="submit">Add domain</button>
          </form>
        </div>
      {% else %}
        <div class="muted" style="font-size:12px;">Create {{ selected_env }} first, then environment settings will appear here.</div>
      {% endif %}
    {% endif %}
  </section>
</div>
<script>
(() => {
  const selectedEnv = "{{ selected_env }}";
  const hasSelectedEnv = {{ "true" if selected_env_obj else "false" }};
  const slots = Array.from(document.querySelectorAll(".branch-slot"));
  const dndForm = document.getElementById("branch-dnd-form");
  const dndSource = document.getElementById("dnd-source-env");
  const dndTarget = document.getElementById("dnd-target-env");
  const dndMode = document.getElementById("dnd-mode");
  const stageNames = { prod: "Production", staging: "Staging", dev: "Development" };
  const longOpWrap = document.getElementById("workspace-long-op");
  const longOpMessage = document.getElementById("workspace-long-op-message");
  let dragSourceEnv = "";
  let isDragging = false;

  const clearDropTargets = () => {
    slots.forEach((slot) => slot.classList.remove("drop-target"));
  };

  const showLongOperation = (message) => {
    if (!longOpWrap) {
      return;
    }
    if (longOpMessage) {
      longOpMessage.textContent = message || "Processing operation...";
    }
    longOpWrap.style.display = "block";
  };

  const submitTransfer = (sourceEnv, targetEnv, mode) => {
    if (!dndForm || !dndSource || !dndTarget || !dndMode) {
      return;
    }
    dndSource.value = sourceEnv;
    dndTarget.value = targetEnv;
    dndMode.value = mode;
    const sourceName = stageNames[sourceEnv] || sourceEnv;
    const targetName = stageNames[targetEnv] || targetEnv;
    if (targetEnv === "dev") {
      showLongOperation(`Resetting Development from ${sourceName}...`);
    } else if (mode === "move") {
      showLongOperation(`Moving ${sourceName} to live (${targetName})...`);
    } else {
      showLongOperation(`Copying ${sourceName} to ${targetName}...`);
    }
    dndForm.submit();
  };

  slots.forEach((slot) => {
    slot.addEventListener("dragstart", (event) => {
      if (slot.dataset.exists !== "1") {
        event.preventDefault();
        return;
      }
      dragSourceEnv = slot.dataset.env || "";
      isDragging = true;
      slot.classList.add("dragging");
      if (event.dataTransfer) {
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", dragSourceEnv);
      }
    });

    slot.addEventListener("dragend", () => {
      isDragging = false;
      dragSourceEnv = "";
      slots.forEach((item) => item.classList.remove("dragging"));
      clearDropTargets();
    });

    slot.addEventListener("click", (event) => {
      if (isDragging) {
        event.preventDefault();
      }
    });

    slot.addEventListener("dragover", (event) => {
      const targetEnv = slot.dataset.env || "";
      if (!dragSourceEnv || dragSourceEnv === targetEnv) {
        return;
      }
      event.preventDefault();
      slot.classList.add("drop-target");
    });

    slot.addEventListener("dragleave", () => {
      slot.classList.remove("drop-target");
    });

    slot.addEventListener("drop", (event) => {
      event.preventDefault();
      const targetEnv = slot.dataset.env || "";
      clearDropTargets();
      if (!dragSourceEnv || !targetEnv || dragSourceEnv === targetEnv) {
        return;
      }

      let mode = "copy";
      let question = `Copy ${stageNames[dragSourceEnv] || dragSourceEnv} to ${stageNames[targetEnv] || targetEnv}?`;
      if (targetEnv === "dev") {
        question = `Reset Development from ${stageNames[dragSourceEnv] || dragSourceEnv}? This overwrites dev database and filestore.`;
      } else if (targetEnv === "prod") {
        mode = "move";
        question = `Move/Merge ${stageNames[dragSourceEnv] || dragSourceEnv} to Production (live)? Source stage will be reset after move.`;
      }
      if (!window.confirm(question)) {
        return;
      }
      submitTransfer(dragSourceEnv, targetEnv, mode);
    });
  });

  const dupPanel = document.getElementById("branch-dup-panel");
  const dupCancel = document.getElementById("branch-dup-cancel");
  const dupForm = document.getElementById("branch-dup-form");
  const dupTargetInput = document.getElementById("dup-target-env");
  const dupSourceSelect = document.getElementById("dup-source-env");
  const dupTargetLabel = document.getElementById("dup-target-label");
  const plusButtons = Array.from(document.querySelectorAll(".branch-plus"));
  const defaultTarget = "{{ selected_env }}";

  const openDuplicatePanel = (targetEnv) => {
    if (!dupPanel || !dupTargetInput || !dupSourceSelect) {
      return;
    }
    dupTargetInput.value = targetEnv;
    if (dupTargetLabel) {
      dupTargetLabel.textContent = `Target stage: ${stageNames[targetEnv] || targetEnv}`;
    }

    const options = Array.from(dupSourceSelect.options);
    options.forEach((opt) => {
      opt.disabled = opt.value === targetEnv;
    });
    if (!dupSourceSelect.value || dupSourceSelect.value === targetEnv) {
      const fallback = options.find((opt) => !opt.disabled);
      if (fallback) {
        dupSourceSelect.value = fallback.value;
      }
    }
    dupPanel.style.display = "block";
    dupSourceSelect.focus();
  };

  plusButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      openDuplicatePanel(btn.dataset.targetEnv || defaultTarget);
    });
  });
  if (dupCancel && dupPanel) {
    dupCancel.addEventListener("click", () => {
      dupPanel.style.display = "none";
    });
  }
  if (dupForm && dupTargetInput && dupSourceSelect) {
    dupForm.addEventListener("submit", (event) => {
      if (!dupSourceSelect.value || dupSourceSelect.value === dupTargetInput.value) {
        event.preventDefault();
        window.alert("Select a source branch different from target.");
        return;
      }
      const sourceName = stageNames[dupSourceSelect.value] || dupSourceSelect.value;
      const targetName = stageNames[dupTargetInput.value] || dupTargetInput.value;
      showLongOperation(`Duplicating ${sourceName} into ${targetName}...`);
    });
  }

  const progressWrap = document.getElementById("workspace-progress-wrap");
  const progressPercent = document.getElementById("workspace-progress-percent");
  const progressMessage = document.getElementById("workspace-progress-message");
  const progressFill = document.getElementById("workspace-progress-fill");
  const updateProgress = (percent, message, tone) => {
    if (!progressWrap || !progressPercent || !progressMessage || !progressFill) {
      return;
    }
    const clamped = Math.max(0, Math.min(100, Number(percent || 0)));
    progressPercent.textContent = `${Math.round(clamped)}%`;
    progressMessage.textContent = message || "Starting";
    progressFill.style.width = `${clamped}%`;
    if ((tone || "").toLowerCase() === "error") {
      progressWrap.classList.add("error");
    } else {
      progressWrap.classList.remove("error");
    }
  };

  const pollProgress = async () => {
    if (!hasSelectedEnv) {
      return;
    }
    try {
      const res = await fetch(`/projects/{{ project.id }}/env/${selectedEnv}/status`, {
        credentials: "same-origin",
        cache: "no-store",
      });
      if (!res.ok) {
        return;
      }
      const data = await res.json();
      updateProgress(data.progress_percent, data.message, data.progress_tone || "info");
    } catch (_) {}
  };

  if (progressWrap && hasSelectedEnv) {
    window.setInterval(pollProgress, 5000);
  }

  document.querySelectorAll("form[data-confirm], form[data-long-action]").forEach((form) => {
    form.addEventListener("submit", (event) => {
      const confirmText = form.getAttribute("data-confirm") || "";
      if (confirmText && !window.confirm(confirmText)) {
        event.preventDefault();
        return;
      }
      const longActionText = form.getAttribute("data-long-action") || "";
      if (longActionText) {
        showLongOperation(longActionText);
      }
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
      }
    });
  });
})();
</script>
{% endif %}
{% endblock %}
