{% extends "base.html" %}
{% block content %}
<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="project-title">Project Settings</div>
      <div class="muted" style="font-size:12px;">Manage branches, capacity, and domains.</div>
    </div>
    <a class="btn" href="/">Back</a>
  </div>
</div>

<form class="card" method="post" action="/projects/{{ project.id }}/settings" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between; margin-bottom:12px;">
    <div class="project-title">Identity</div>
  </div>
  <div class="grid">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Display name</div>
      <input class="input" name="display_name" value="{{ project.display_name or project.slug }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Slug (immutable)</div>
      <input class="input" value="{{ project.slug }}" disabled />
    </div>
  </div>
  <div class="spacer"></div>

  <div class="project-title" style="margin-bottom:10px;">Branch Mapping</div>
  <div class="grid">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Development branch</div>
      <input class="input" name="dev_branch" value="{{ project.dev_branch or 'dev' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branch</div>
      <input class="input" name="staging_branch" value="{{ project.staging_branch or 'staging' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Production branch</div>
      <input class="input" name="prod_branch" value="{{ project.prod_branch or 'main' }}" />
    </div>
  </div>
  <div class="spacer"></div>

  <div class="project-title" style="margin-bottom:10px;">Capacity</div>
  <div class="grid">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Database workers</div>
      <input class="input" type="number" min="1" name="workers" value="{{ project.workers or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Filestore size (Gi)</div>
      <input class="input" type="number" min="1" name="storage_gb" value="{{ project.storage_gb or 1 }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Staging branches</div>
      <input class="input" type="number" min="1" name="staging_slots" value="{{ project.staging_slots or 1 }}" />
    </div>
  </div>
  <div class="spacer"></div>

  <div class="project-title" style="margin-bottom:10px;">Subscription</div>
  <div class="grid">
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Subscription code</div>
      <input class="input" name="subscription_code" value="{{ project.subscription_code or '' }}" />
    </div>
    <div>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Odoo version</div>
      <input class="input" name="odoo_version" value="{{ project.odoo_version or '19.0' }}" />
    </div>
  </div>
  <div class="spacer"></div>

  <div class="row" style="justify-content: flex-end;">
    <button class="btn primary" type="submit">Save settings</button>
  </div>
</form>

<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="project-title">GitHub</div>
      <div class="muted" style="font-size:12px;">Connect a repository to enable branch-based deployments.</div>
    </div>
    <a class="btn" href="{{ github_install_url }}" target="_blank">Install GitHub App</a>
  </div>
  <div class="spacer"></div>
  <form method="post" action="/projects/{{ project.id }}/repo">
    <div class="grid">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Repository (owner/name)</div>
        <input class="input" name="repo_full_name" value="{{ project.repo_full_name or '' }}" list="repo-list" />
        <datalist id="repo-list">
          {% for repo in repos %}
            <option value="{{ repo.full_name }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Installation</div>
        <select class="input" name="installation_id">
          <option value="">Select installation</option>
          {% for inst in installations %}
            <option value="{{ inst.installation_id }}" {% if project.installation_id == inst.installation_id %}selected{% endif %}>
              {{ inst.account_login }} ({{ inst.installation_id }})
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row" style="justify-content: flex-end;">
      <button class="btn primary" type="submit">Connect repository</button>
    </div>
  </form>

  {% if project.repo_full_name %}
  <div class="spacer"></div>
  <div class="muted" style="font-size:12px;">Connected repository: <strong>{{ project.repo_full_name }}</strong></div>
  {% endif %}
</div>

<div class="card" style="margin-bottom:16px;">
  <div class="project-title">Recent Builds</div>
  {% if builds %}
    {% for build in builds %}
      <div class="row" style="justify-content: space-between; margin-bottom:6px;">
        <span class="muted" style="font-size:12px;">{{ build.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        <span>{{ build.branch or 'n/a' }} â†’ {{ build.env or 'n/a' }}</span>
        <span class="muted" style="font-size:12px;">{{ build.status or '' }}</span>
      </div>
      <div class="muted" style="font-size:12px; margin-bottom:10px;">{{ build.message or '' }}</div>
    {% endfor %}
  {% else %}
    <div class="muted" style="font-size:12px;">No builds yet.</div>
  {% endif %}
</div>

<div class="card">
  <div class="project-title">Environments & Domains</div>
  <div class="muted" style="font-size:12px; margin-bottom:12px;">
    Use the base subdomain or attach custom domains per environment. Ensure DNS A records point to your ingress IP.
  </div>

  {% set env_names = project.envs | map(attribute='name') | list %}
  {% for env_name in ["prod","staging","dev"] %}
    {% set env = (project.envs | selectattr("name","equalto", env_name) | list | first) %}
    <div class="card" style="margin-bottom:12px; background: #0b1220;">
      <div class="row" style="justify-content: space-between;">
        <div class="row">
          <span class="env-pill">{{ env_name }}</span>
          {% if env %}
            <span class="muted" style="font-size:12px;">{{ env.host }}</span>
          {% else %}
            <span class="muted" style="font-size:12px;">Not created yet</span>
          {% endif %}
        </div>
        <div class="row">
          {% if env %}
            <a class="btn" href="https://{{ env.host }}" target="_blank">Open</a>
          {% endif %}
          {% if env_name != "dev" and env %}
            <form method="post" action="/projects/{{ project.id }}/promote">
              <input type="hidden" name="source_env" value="{{ "dev" if env_name == "staging" else "staging" }}" />
              <input type="hidden" name="target_env" value="{{ env_name }}" />
              <button class="btn ghost" type="submit">Promote</button>
            </form>
          {% elif env_name == "staging" and not env %}
            <form method="post" action="/projects/{{ project.id }}/promote">
              <input type="hidden" name="source_env" value="dev" />
              <input type="hidden" name="target_env" value="staging" />
              <button class="btn ghost" type="submit">Create</button>
            </form>
          {% elif env_name == "prod" and not env %}
            <form method="post" action="/projects/{{ project.id }}/promote">
              <input type="hidden" name="source_env" value="staging" />
              <input type="hidden" name="target_env" value="prod" />
              <button class="btn ghost" type="submit">Create</button>
            </form>
          {% endif %}
          {% if env_name == "dev" and env %}
            <form method="post" action="/projects/{{ project.id }}/reset">
              <input type="hidden" name="env" value="dev" />
              <button class="btn ghost danger" type="submit">Reset Dev</button>
            </form>
          {% endif %}
        </div>
      </div>
      <div class="spacer"></div>
      {% if env %}
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Custom domains</div>
        {% if env.domains %}
          {% for domain in env.domains %}
            <div class="row" style="justify-content: space-between; margin-bottom:6px;">
              <span>{{ domain.host }}</span>
              <form method="post" action="/projects/{{ project.id }}/domains/{{ domain.id }}/delete">
                <button class="btn ghost danger" type="submit">Remove</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="font-size:12px;">No custom domains yet.</div>
        {% endif %}
        <div class="spacer"></div>
        <form method="post" action="/projects/{{ project.id }}/domains" class="row">
          <input type="hidden" name="env_id" value="{{ env.id }}" />
          <input class="input" name="host" placeholder="custom.domain.com" required />
          <button class="btn primary" type="submit">Add domain</button>
        </form>
      {% endif %}
    </div>
  {% endfor %}
</div>
{% endblock %}
