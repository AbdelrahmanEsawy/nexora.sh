{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="project-title">{{ project.display_name or project.slug }} · {{ env_name }}</div>
  <div class="muted" style="font-size:12px; margin-bottom:12px;">
    We’re preparing your environment. This can take a few minutes on first boot.
  </div>
  <div class="row" style="align-items: center; gap: 16px;">
    <div class="spinner"></div>
    <div>
      <div id="status-text" style="font-weight:600;">{{ status.message or "Starting" }}</div>
      <div class="muted" style="font-size:12px;">We’ll redirect you once it’s ready.</div>
    </div>
  </div>
  <div style="margin-top:12px;">
    <div class="row" style="justify-content:space-between;">
      <span class="muted" style="font-size:12px;">Progress</span>
      <span id="progress-percent" class="muted" style="font-size:12px;">0%</span>
    </div>
    <div style="height:8px; border-radius:999px; background:rgba(255,255,255,0.12); overflow:hidden; margin-top:6px;">
      <div id="progress-fill" style="height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg,#22d3ee,#ff7a59); transition:width 0.35s ease;"></div>
    </div>
  </div>
  <div class="spacer"></div>
  <div class="row">
    <a class="btn ghost" href="/projects/{{ project.id }}/settings">Back</a>
    <a id="open-btn" class="btn disabled" href="#" target="_blank" aria-disabled="true">Open when ready</a>
  </div>
</div>

<script>
  (function () {
    const statusEl = document.getElementById("status-text");
    const openBtn = document.getElementById("open-btn");
    const progressPercent = document.getElementById("progress-percent");
    const progressFill = document.getElementById("progress-fill");
    function setOpenReady(host) {
      openBtn.classList.remove("disabled");
      openBtn.removeAttribute("aria-disabled");
      openBtn.href = `https://${host}`;
      openBtn.textContent = "Open now";
    }

    async function poll() {
      try {
        const res = await fetch(`/projects/{{ project.id }}/env/{{ env_name }}/status`, {
          credentials: "same-origin",
        });
        if (res.ok) {
          const data = await res.json();
          statusEl.textContent = data.message || "Starting";
          const pct = Math.max(0, Math.min(100, Number(data.progress_percent || 0)));
          progressPercent.textContent = `${Math.round(pct)}%`;
          progressFill.style.width = `${pct}%`;
          if (data.ready) {
            setOpenReady(data.host || "{{ env.host }}");
            window.location.href = `https://${data.host || "{{ env.host }}"}`;
            return;
          }
          if (data.message && data.message.toLowerCase().includes("init failed")) {
            openBtn.textContent = "Blocked: initialization failed";
          } else if (data.message && data.message.toLowerCase().includes("provisioning failed")) {
            openBtn.textContent = "Blocked: provisioning failed";
          } else if (data.message && data.message.toLowerCase().includes("runtime deployment missing")) {
            openBtn.textContent = "Blocked: runtime deployment missing";
          } else if (data.message && data.message.toLowerCase().includes("tls")) {
            openBtn.textContent = "Waiting for TLS";
          } else {
            openBtn.textContent = "Open when ready";
          }
        }
      } catch (e) {}
      setTimeout(poll, 4000);
    }
    setTimeout(poll, 1500);
  })();
</script>
{% endblock %}
