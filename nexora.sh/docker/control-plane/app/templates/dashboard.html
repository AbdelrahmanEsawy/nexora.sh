{% extends "base.html" %}
{% block content %}
<style>
  @media (max-width: 920px) {
    .create-project-grid {
      grid-template-columns: 1fr !important;
    }
  }
</style>
<div class="card" id="new-project" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between; margin-bottom:12px;">
    <div>
      <div class="project-title">Create a Project</div>
      <div class="muted" style="font-size:12px;">Provisions dev first. You can then promote to staging and production.</div>
    </div>
  </div>
  <form method="post" action="/projects" id="create-project-form">
    <div class="grid create-project-grid" style="grid-template-columns: 1.3fr 1fr; align-items: end;">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Display name</div>
        <input class="input" type="text" name="display_name" placeholder="Project name" value="{{ prefill_display or '' }}" required>
      </div>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:6px;">Slug</div>
        <input class="input" type="text" name="slug" placeholder="project-slug" value="{{ prefill_slug or '' }}" pattern="[a-z0-9][a-z0-9-]{1,30}" title="2–31 chars, lowercase letters/numbers, hyphens only" required>
      </div>
    </div>

    <div class="spacer"></div>
    <div class="project-title" style="font-size:16px; margin-bottom:8px;">Hosting location</div>
    <div class="muted" style="font-size:12px; margin-bottom:10px;">
      Regions are loaded from your OVH project quota. We preselect the lowest-latency region with free capacity.
    </div>

    <input type="hidden" id="hosting-location" name="hosting_location" value="{{ prefill_hosting_location or '' }}">
    <input type="hidden" id="hosting-ping-ms" name="hosting_ping_ms" value="{{ prefill_hosting_ping or '' }}">
    <input type="hidden" id="hosting-probe-results" name="hosting_probe_results" value="">

    <div id="hosting-grid" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(165px, 1fr)); gap:10px;">
      {% for item in hosting_locations %}
      <button
        type="button"
        class="btn ghost hosting-option"
        data-location="{{ item.code }}"
        data-probe-url="{{ item.probe_url }}"
        style="justify-content: space-between; text-align:left; width:100%;"
      >
        <span>
          <strong style="display:block; color:var(--text);">{{ item.label }}</strong>
          <span class="muted" style="font-size:11px;">{{ item.region }}</span>
          <span class="muted" data-capacity style="display:block; font-size:10px; margin-top:4px;"></span>
        </span>
        <span class="muted" data-ping style="font-size:11px;">Testing...</span>
      </button>
      {% endfor %}
    </div>

    <div class="row" style="justify-content: space-between; margin-top:10px;">
      <div id="hosting-summary" class="muted" style="font-size:12px;">Measuring ping to hosting regions...</div>
      <button class="btn primary" type="submit" style="height:42px;">Create Project</button>
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px;">Slug format: 2–31 chars, lowercase letters/numbers, hyphens only.</div>
  </form>
</div>

{% if stale_project_count and stale_project_count > 0 %}
<div class="card" style="margin-bottom:16px;">
  <div class="row" style="justify-content: space-between;">
    <div class="muted" style="font-size:12px;">
      {{ stale_project_count }} project(s) are stuck in deletion state. You can clear them from the dashboard while background cleanup continues.
    </div>
    <form method="post" action="/projects/cleanup/stale">
      <button class="btn ghost danger" type="submit">Clear stale deletions</button>
    </form>
  </div>
</div>
{% endif %}

{% if user and user.is_admin %}
<div class="card" style="margin-bottom:16px;">
  <div class="project-title" style="font-size:16px; margin-bottom:8px;">Maintenance</div>
  <div class="muted" style="font-size:12px; margin-bottom:10px;">
    Use this to purge orphan resources for old deleted projects. Deleted project URLs may still show nginx `404` because wildcard DNS still points to the ingress controller; this is expected.
  </div>
  <div class="row">
    <form method="post" action="/admin/maintenance/purge-old">
      <input type="hidden" name="backups_mode" value="retention" />
      <input type="hidden" name="backup_retention_days" value="2" />
      <button class="btn" type="submit">Purge orphans + backups older than 2 days</button>
    </form>
    <form method="post" action="/admin/maintenance/purge-old">
      <input type="hidden" name="backups_mode" value="purge_all" />
      <input type="hidden" name="backup_retention_days" value="2" />
      <button class="btn ghost danger" type="submit">Purge orphans + ALL backups</button>
    </form>
  </div>
</div>
{% endif %}

{% if not projects %}
<div class="card" style="margin-bottom:16px;">
  <div class="project-title">No Projects Yet</div>
  <div class="muted" style="font-size:12px;">Create your first project to start provisioning Odoo environments.</div>
</div>
{% endif %}

<div class="grid">
  {% for project in projects %}
  {% set loc = hosting_location_map.get(project.hosting_location or '') %}
  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div>
        <div class="project-title">{{ project.display_name or project.slug }}</div>
        <div class="muted" style="font-size:12px;">Slug: {{ project.slug }} · Owner: {{ project.owner.username }}</div>
        <div class="muted" style="font-size:12px; margin-top:4px;">
          Hosting: {{ loc['label'] if loc else (project.hosting_location|upper if project.hosting_location else 'Auto') }}{% if project.hosting_ping_ms %} · {{ project.hosting_ping_ms }}ms{% endif %}
        </div>
        {% if project.status == "deleting" %}
          <div class="muted" style="font-size:12px; color:#fcd34d; margin-top:6px;">Deletion in progress. Resources are being removed in background.</div>
        {% elif project.status == "delete_failed" %}
          <div class="muted" style="font-size:12px; color:#fecaca; margin-top:6px;">Deletion failed: {{ project.last_error or "Unknown error" }}</div>
        {% endif %}
      </div>
      <div class="row">
        <a class="btn {% if project.status == 'deleting' %}disabled{% endif %}" href="/projects/{{ project.id }}/settings">Settings</a>
        <form method="post" action="/projects/{{ project.id }}/delete">
          <button class="btn ghost danger {% if project.status == 'deleting' %}disabled{% endif %}" type="submit" {% if project.status == "deleting" %}disabled{% endif %}>
            {{ "Deleting..." if project.status == "deleting" else "Delete" }}
          </button>
        </form>
        {% if project.status in ["deleting", "delete_failed"] %}
        <form method="post" action="/projects/{{ project.id }}/delete/force">
          <button class="btn ghost" type="submit">Force clear</button>
        </form>
        {% endif %}
      </div>
    </div>
    <div class="spacer"></div>
    {% for env_name in ["prod","staging","dev"] %}
      {% set env = (project.envs | selectattr("name","equalto", env_name) | list | first) %}
      <div class="row" style="justify-content: space-between; margin-bottom:6px;">
        <span class="env-pill">{{ env_name }}</span>
        {% if env %}
          <a class="btn {% if project.status in ['deleting', 'delete_failed'] %}disabled{% endif %}" href="/projects/{{ project.id }}/env/{{ env_name }}/open">Open</a>
        {% else %}
          <a class="btn ghost {% if project.status in ['deleting', 'delete_failed'] %}disabled{% endif %}" href="/projects/{{ project.id }}/settings">Create</a>
        {% endif %}
      </div>
      {% if env %}
        <div class="muted" style="font-size:12px;">{{ env.host }}</div>
        <div class="muted" style="font-size:12px; margin-top:2px;">
          {% if env.status == "provisioning" %}
            Status: provisioning
          {% elif env.status == "failed" %}
            <span style="color:#fecaca;">Status: failed{% if env.last_error %} · {{ env.last_error }}{% endif %}</span>
          {% else %}
            Status: active
          {% endif %}
        </div>
      {% else %}
        <div class="muted" style="font-size:12px;">Not created yet</div>
      {% endif %}
      <div class="spacer"></div>
    {% endfor %}
  </div>
  {% endfor %}
</div>

<script>
  (function () {
    const cards = Array.from(document.querySelectorAll('.hosting-option'));
    const hiddenLocation = document.getElementById('hosting-location');
    const hiddenPing = document.getElementById('hosting-ping-ms');
    const hiddenProbeResults = document.getElementById('hosting-probe-results');
    const summary = document.getElementById('hosting-summary');
    if (!cards.length || !hiddenLocation || !hiddenPing || !hiddenProbeResults || !summary) {
      return;
    }

    const pingState = {};
    const probeUrlByCode = {};
    let capacityState = { mode: 'unknown', message: '', locations: {} };
    let manualSelection = false;

    function cardLabel(code) {
      return cards.find((card) => card.dataset.location === code)?.querySelector('strong')?.textContent || code;
    }

    function isSelectable(code) {
      if (!code) return false;
      if (capacityState.mode !== 'active') return true;
      const entry = (capacityState.locations || {})[code];
      return Boolean(entry && entry.available);
    }

    function setProbePayload() {
      const payload = {};
      Object.entries(pingState).forEach(([code, ping]) => {
        if (typeof ping === 'number') {
          payload[code] = ping;
        }
      });
      hiddenProbeResults.value = JSON.stringify(payload);
    }

    function capacityText(code) {
      const entry = (capacityState.locations || {})[code];
      if (!entry) return '';
      if (capacityState.mode === 'active') {
        if (entry.available) {
          return entry.region ? `OVH ${entry.region} available` : 'OVH quota available';
        }
        return entry.reason || 'OVH no capacity';
      }
      if (capacityState.mode === 'error') return 'OVH quota lookup unavailable';
      if (capacityState.mode === 'disabled') return 'OVH quota check disabled';
      return '';
    }

    function repaintCards(selectedCode) {
      cards.forEach((card) => {
        const code = card.dataset.location || '';
        const pingNode = card.querySelector('[data-ping]');
        const capNode = card.querySelector('[data-capacity]');
        const ping = pingState[code];
        if (pingNode) {
          if (!probeUrlByCode[code]) {
            pingNode.textContent = 'n/a';
          } else {
            pingNode.textContent = typeof ping === 'number' ? `${ping}ms` : 'timeout';
          }
        }
        if (capNode) {
          capNode.textContent = capacityText(code);
        }

        const selectable = isSelectable(code);
        card.disabled = !selectable;
        card.style.opacity = selectable ? '1' : '0.55';

        if (!selectable) {
          card.classList.add('ghost');
          card.style.borderColor = 'rgba(239,68,68,0.45)';
          card.style.background = 'rgba(239,68,68,0.08)';
          return;
        }

        if (code === selectedCode) {
          card.classList.remove('ghost');
          card.style.borderColor = 'rgba(34,211,238,0.6)';
          card.style.background = 'rgba(34,211,238,0.12)';
          return;
        }
        card.classList.add('ghost');
        card.style.borderColor = 'rgba(255,255,255,0.1)';
        card.style.background = 'transparent';
      });
    }

    function updateSummary(code) {
      if (!code) {
        if (capacityState.mode === 'active') {
          summary.textContent = 'Auto-selecting from OVH regions with available quota.';
        } else {
          summary.textContent = 'Auto selection is enabled.';
        }
        return;
      }
      const selectedPing = pingState[code];
      const pingLabel = !probeUrlByCode[code]
        ? 'n/a'
        : (typeof selectedPing === 'number' ? `${selectedPing}ms` : 'timeout');
      const label = cardLabel(code);
      const entry = (capacityState.locations || {})[code];
      if (capacityState.mode === 'active' && entry) {
        const regionLabel = entry.region ? ` · OVH ${entry.region}` : '';
        summary.textContent = `Selected region: ${label} (${pingLabel}${regionLabel}).`;
        return;
      }
      summary.textContent = `Selected region: ${label} (${pingLabel}).`;
    }

    function pickCard(code) {
      if (code && !isSelectable(code)) {
        return;
      }
      hiddenLocation.value = code || '';
      const selectedPing = pingState[code];
      hiddenPing.value = typeof selectedPing === 'number' ? String(selectedPing) : '';
      repaintCards(code);
      updateSummary(code);
    }

    async function probeOnce(url, timeoutMs) {
      if (!url) return null;
      const token = `cb=${Date.now()}-${Math.random().toString(16).slice(2)}`;
      const probeUrl = `${url}${url.includes('?') ? '&' : '?'}${token}`;
      const start = performance.now();
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        await fetch(probeUrl, {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-store',
          credentials: 'omit',
          signal: controller.signal,
        });
        return Math.round(performance.now() - start);
      } catch (_) {
        return null;
      } finally {
        clearTimeout(timer);
      }
    }

    async function measurePing(url) {
      const samples = [
        await probeOnce(url, 2200),
        await probeOnce(url, 2200),
        await probeOnce(url, 2200),
      ].filter((value) => typeof value === 'number');
      if (!samples.length) return null;
      const sorted = samples.slice().sort((left, right) => left - right);
      return Math.round(sorted[Math.floor(sorted.length / 2)]);
    }

    async function loadCapacity() {
      try {
        const response = await fetch('/api/hosting/availability', {
          method: 'GET',
          credentials: 'same-origin',
          cache: 'no-store',
        });
        if (!response.ok) return null;
        return await response.json();
      } catch (_) {
        return null;
      }
    }

    function bestAutoCode() {
      const selectableCodes = cards
        .map((card) => card.dataset.location || '')
        .filter((code) => code && isSelectable(code));
      if (!selectableCodes.length) return '';
      return selectableCodes.sort((left, right) => {
        const leftPing = pingState[left];
        const rightPing = pingState[right];
        const leftHas = typeof leftPing === 'number';
        const rightHas = typeof rightPing === 'number';
        if (leftHas && rightHas) return leftPing - rightPing;
        if (leftHas) return -1;
        if (rightHas) return 1;
        return 0;
      })[0];
    }

    cards.forEach((card) => {
      card.addEventListener('click', () => {
        if (card.disabled) return;
        manualSelection = true;
        pickCard(card.dataset.location || '');
      });
    });

    const prefillCode = hiddenLocation.value;
    if (prefillCode) {
      manualSelection = true;
    }

    const pingPromiseByUrl = Object.create(null);
    Promise.all(cards.map(async (card) => {
      const code = card.dataset.location || '';
      const probeUrl = card.dataset.probeUrl || '';
      probeUrlByCode[code] = probeUrl;
      if (!probeUrl) {
        pingState[code] = null;
        return;
      }
      if (!pingPromiseByUrl[probeUrl]) {
        pingPromiseByUrl[probeUrl] = measurePing(probeUrl);
      }
      const ping = await pingPromiseByUrl[probeUrl];
      pingState[code] = ping;
    })).then(async () => {
      setProbePayload();
      const capacity = await loadCapacity();
      if (capacity && typeof capacity === 'object') {
        capacityState = capacity;
      }
      repaintCards(hiddenLocation.value || '');

      const currentCode = hiddenLocation.value || '';
      if (manualSelection && currentCode && isSelectable(currentCode)) {
        pickCard(currentCode);
        return;
      }

      const autoCode = bestAutoCode();
      if (autoCode) {
        pickCard(autoCode);
        return;
      }

      hiddenLocation.value = '';
      hiddenPing.value = '';
      repaintCards('');
      if (capacityState.mode === 'active') {
        summary.textContent = 'No OVH location currently has free quota.';
      } else {
        summary.textContent = 'Unable to auto-select a location.';
      }
    });
  })();
</script>
{% endblock %}
